# ai-team-workflow config
#
# This file is YAML (or JSON) and is parsed via `yaml.safe_load` when available.
#
# Share dir (where registry/task/design/state live):
# - If set (non-empty), it overrides the default shared state directory.
# - Recommended: absolute path
# - Relative paths are resolved from the skill root (`.codex/skills/ai-team-workflow/`)
#
# Default when unset/empty: <skill_root>/share
share:
  dir: ""

# Backward-compatible (older scripts):
# share_dir: ""

# Team policy (hard constraints)
#
# Notes:
# - 权限/可雇佣关系写在 policy（硬约束）里，不写在角色模板里。
# - 本分支是迁移团队：组织树固定为 `coord -> task_admin -> (migrator, reviewer, regress)`。
team:
  # Worker runtime environment
  #
  # When `env.venv` is set, every tmux worker will start Codex under that Python
  # virtualenv so `python`/`pytest` resolve to the venv without extra setup.
  env:
    # Python virtualenv directory (must contain `bin/activate`). Leave empty to disable.
    venv: "/root/.virtualenvs/py_ui_test"

  # Team initialization (what `atwf init` starts automatically)
  init:
    # Who receives the shared task on init (via `twf ask`).
    # Must be either the root_role or one of the init children roles.
    task_owner_role: coord

    # Children spawned under root_role on init (optional).
    # - Set to [] to boot root only; spawn one task_admin per migration task later.
    children: []

  policy:
    # Root role (single root). Non-root roles must be created via spawn (must have a parent).
    root_role: "coord"

    # Operator/user-facing role (the only role allowed to ask the user).
    user_role: "coord"

    # Project-enabled roles (must have a matching templates/<role>.md).
    enabled_roles:
      - coord
      - task_admin
      - migrator
      - reviewer
      - regress

    # Hiring policy (who can spawn which roles). The operator/runtime team decides
    # the actual org by spawning, but the role types must be allowed here.
    can_hire:
      coord: [task_admin]
      task_admin: [migrator, reviewer, regress]

    # Broadcast governance
    broadcast:
      allowed_roles: [coord]
      exclude_roles: []

    # Direct communication governance (who can DM/ask whom)
    comm:
      # Allow parent<->child communications regardless of role.
      allow_parent_child: true

      # Role-to-role direct communication matrix (bidirectional).
      # For this migration team, keep topology strict:
      # - task_admin <-> coord
      # - task_admin <-> (migrator/reviewer/regress) is covered by parent-child allowance.
      direct_allow:
        coord: [task_admin]
        task_admin: [coord]

      require_handoff: false
      handoff_creators: []

  # Per-role spec docs (paths). These are included in bootstrap as a required
  # reading list, and are the source of truth for each role’s checklist.
  #
  # Paths can be absolute, or relative to the project git root.
  role_specs:
    migrator:
      - "task/workflow.md"
    reviewer:
      - "task/workflow.md"
    regress:
      - "task/workflow.md"

  # Drive loop (anti-stall)
  #
  # When `mode=running`, the watcher will treat "all members idle + all inbox empty"
  # as an abnormal stall and will wake a single driver to re-kickoff work or switch
  # to standby explicitly.
  drive:
    mode: running # running | standby
    driver_role: task_admin     # (migration team) who is woken to drive a stalled task subtree
    backup_role: coord          # fallback if task_admin is missing
    cooldown: 600          # seconds between repeated drive nudges

  # Reply-needed requests (fan-in replies without CLI injection)
  #
  # - Initiator uses: `atwf gather ...`
  # - Targets reply via: `atwf respond ...` (or `--blocked` to snooze reminders)
  # - Watcher will reply-drive (wake debtors) when team is stalled but replies are pending.
  reply:
    deadline: 3600        # seconds until auto-timeout / consolidation
    blocked_snooze: 900   # default snooze for `atwf respond --blocked` (seconds)

  # Message delivery (hard default behavior)
  # - Full message bodies are stored in {{TEAM_DIR}}/inbox/...
  # - Chat prompts contain only short [INBOX] id=... notifications
  messaging:
    inbox:
      # Max active unread items per sender->recipient thread; older unread are moved to inbox/overflow.
      max_unread_per_thread: 15

    # Agent standby + inbox polling
  #
  # Notes:
  # - "working" agents should proactively check inbox periodically to avoid queue buildup.
  # - "idle" agents do NOT proactively poll inbox; they are woken by `atwf watch-idle` (operator sidecar).
  state:
    # While working, check inbox at least every N seconds.
    inbox_check_interval: 60

    # If a member is idle and new inbox messages arrive, schedule a wakeup after N seconds.
    idle_wake_delay: 60

    # Poll interval for `atwf watch-idle` (seconds).
    watch_interval: 60

    # Activity-derived state (watcher-managed).
    #
    # The watcher infers `working` vs `idle` by sampling the worker's tmux pane output:
    # - if the output hash changed within `activity_window`, consider it active (`working`)
    # - after a wake injection, keep it active for `active_grace_period` to avoid flapping
    activity_window: 120
    active_grace_period: 180
    activity_capture_lines: 200

    # Auto-unblock: if Codex is showing an approval menu inside the worker TUI,
    # send an Enter keystroke to accept the default choice and continue.
    auto_enter:
      enabled: true
      cooldown: 30
      tail_window_lines: 80
      patterns:
        - "3. No, and tell Codex what to do differently (esc)"

    # Minimal wake message injected into Codex TUI (no full body here).
    wake_message: "INBOX wake: you have unread messages. Run: bash .codex/skills/ai-team-workflow/scripts/atwf inbox"
    reply_wake_message: "REPLY wake: you have pending reply-needed. Run: bash .codex/skills/ai-team-workflow/scripts/atwf reply-needed"

    # Governance: if a worker is `working` but has pending inbox items older than N seconds,
    # the watcher writes an inbox-only alert to the owning task_admin (and injects a short notice if they are running).
    working_stale_threshold: 180
    working_alert_cooldown: 600
