# ai-team-workflow config
#
# This file is YAML (or JSON) and is parsed via `yaml.safe_load` when available.
#
# Share dir (where registry/task/design/ops live):
# - If set (non-empty), it overrides the default shared state directory.
# - Recommended: absolute path
# - Relative paths are resolved from the skill root (`.codex/skills/ai-team-workflow/`)
#
# Default when unset/empty: <skill_root>/share
share:
  dir: ""

# Backward-compatible (older scripts):
# share_dir: ""

# Team policy (hard constraints)
#
# Notes:
# - 权限/可雇佣关系写在 policy（硬约束）里，不写在角色模板里。
# - 组织树（谁雇佣谁、开几个 dev/qa）由 PM 在运行时决定，但必须满足下面的规则。
team:
  policy:
    # Root role (single root). Non-root roles must be created via spawn (must have a parent).
    root_role: "coord"

    # Project-enabled roles (must have a matching templates/<role>.md).
    enabled_roles:
      - coord
      - pm
      - liaison
      - arch
      - dev
      - qa
      - prod
      - ops

    # Hiring policy (who can spawn which roles). PM decides actual org by spawning,
    # but the role types must be allowed here.
    can_hire:
      coord: [pm, liaison]
      pm: [arch, dev, qa, prod, ops]
      arch: [dev, qa, prod]
      # Optional self-scaling (interns/assistants) by role label (e.g. dev-intern):
      dev: [dev]
      qa: [qa]
      prod: [prod]
      ops: [ops]

    # Broadcast governance
    broadcast:
      allowed_roles: [coord]
      # Default internal broadcast audience should exclude liaison unless explicitly targeted.
      exclude_roles: [liaison]

    # Direct communication governance (who can DM/ask whom without handoff)
    comm:
      # Allow parent<->child communications regardless of role.
      allow_parent_child: true

      # Role-to-role direct communication matrix (bidirectional).
      # Example: dev (including dev interns) can talk to prod/qa directly.
      direct_allow:
        # Anyone can ask coord for routing/authorization.
        coord: [pm, arch, dev, qa, prod, ops, liaison]
        pm: [liaison]
        dev: [prod, qa]
        qa: [prod, dev]
        prod: [dev, qa]

      # Otherwise, cross-branch conversations require a handoff/permit (to avoid relaying).
      require_handoff: true

      # Who can create handoffs/permits.
      handoff_creators: [coord, pm, arch]

  # Drive loop (anti-stall)
  #
  # When `mode=running`, the watcher will treat "all members idle + all inbox empty"
  # as an abnormal stall and will wake a single driver to re-kickoff work or switch
  # to standby explicitly.
  drive:
    mode: running # running | standby
    driver_role: coord     # who is woken to drive the team
    backup_role: pm        # escalation target if driver is missing
    cooldown: 600          # seconds between repeated drive nudges
    message:
      # Summary is what gets injected into the driver’s Codex prompt (short).
      # Body is stored in inbox-open <msg_id> (full details).
      #
      # Placeholders:
      # - {{iso_ts}}   detection timestamp (ISO8601)
      # - {{msg_id}}   inbox message id
      # - {{open_cmd}} open command for the inbox body
      summary: |
        [DRIVE] team stalled: ALL IDLE + INBOX EMPTY
        inbox id={{msg_id}} (open: {{open_cmd}})
        Action: diagnose root cause, then re-drive the team back to work.
      body: |
        [DRIVE] team stalled: ALL IDLE + INBOX EMPTY
        - detected_at: {{iso_ts}}
        - meaning: no one is driving work. This is an ABNORMAL STALL.

        1) Diagnose now:
        - atwf state
        - atwf list
        - atwf inbox (your own inbox)

        Summarize why the team reached "all idle + inbox empty", find the root cause, then re-drive the team back to work.

  # Reply-needed requests (fan-in replies without CLI injection)
  #
  # - Initiator uses: `atwf gather ...`
  # - Targets reply via: `atwf respond ...` (or `--blocked` to snooze reminders)
  # - Watcher will reply-drive (wake debtors) when team is stalled but replies are pending.
  reply:
    deadline: 3600        # seconds until auto-timeout / consolidation
    blocked_snooze: 900   # default snooze for `atwf respond --blocked` (seconds)

  # Message delivery (hard default behavior)
  # - Full message bodies are stored in {{TEAM_DIR}}/inbox/...
  # - Chat prompts contain only short [INBOX] id=... notifications
  messaging:
    inbox:
      # Max active unread items per sender->recipient thread; older unread are moved to inbox/overflow.
      max_unread_per_thread: 15

  # Agent standby + inbox polling
  #
  # Notes:
  # - "working" agents should proactively check inbox periodically to avoid queue buildup.
  # - "idle" agents do NOT proactively poll inbox; they are woken by `atwf watch-idle` (operator sidecar).
  state:
    # While working, check inbox at least every N seconds.
    inbox_check_interval: 60

    # If a member is idle and new inbox messages arrive, schedule a wakeup after N seconds.
    idle_wake_delay: 60

    # Poll interval for `atwf watch-idle` (seconds).
    watch_interval: 60

    # Activity-derived state (watcher-managed).
    #
    # The watcher infers `working` vs `idle` by sampling the worker's tmux pane output:
    # - if the output hash changed within `activity_window`, consider it active (`working`)
    # - after a wake injection, keep it active for `active_grace_period` to avoid flapping
    activity_window: 120
    active_grace_period: 180
    activity_capture_lines: 200

    # Auto-unblock: if Codex is showing an approval menu inside the worker TUI,
    # send an Enter keystroke to accept the default choice and continue.
    auto_enter:
      enabled: true
      cooldown: 30
      tail_window_lines: 80
      patterns:
        - "3. No, and tell Codex what to do differently (esc)"

    # Minimal wake message injected into Codex TUI (no full body here).
    wake_message: "INBOX wake: you have unread messages. Run: bash .codex/skills/ai-team-workflow/scripts/atwf inbox"
    reply_wake_message: "REPLY wake: you have pending reply-needed. Run: bash .codex/skills/ai-team-workflow/scripts/atwf reply-needed"

    # Governance: if a worker is `working` but has pending inbox items older than N seconds,
    # the watcher writes an inbox-only alert to coord (no CLI injection).
    working_stale_threshold: 180
    working_alert_cooldown: 600
